#!/bin/zsh

# Clear port - kills all processes on a given port
cport() {
  local port=$1
  if [ -z "$port" ]; then
    echo "Usage: cport <port>"
    return 1
  fi

  local pids=$(lsof -t -i :"$port" 2>/dev/null)
  if [ -z "$pids" ]; then
    echo "No process found on port $port"
    return 1
  fi

  local count=$(echo "$pids" | wc -l | tr -d ' ')
  echo "$pids" | xargs kill -9 2>/dev/null
  echo "Killed $count process(es) on port $port: $(echo $pids | tr '\n' ' ')"
}

# Fuzzy find thoughts - instant results with live preview
# Enter = view with glow, ctrl-e = edit in nvim
thought() {
  local query="${1:-}"
  local searchdir="$HOME/thoughts"

  if [[ ! -d "$searchdir" ]]; then
    echo "No thoughts repository found at $searchdir"
    return 1
  fi

  # If query provided, start with ripgrep results; otherwise show all files
  local initial_cmd
  if [[ -n "$query" ]]; then
    initial_cmd="rg --files-with-matches --no-messages '$query' $searchdir 2>/dev/null | sed 's|^$searchdir/||'"
  else
    initial_cmd="find $searchdir -type f -name '*.md' -not -path '*/.git/*' | sed 's|^$searchdir/||'"
  fi

  local result
  result=$(eval "$initial_cmd" | \
    fzf --query="$query" \
        --preview "glow -s dark $searchdir/{} 2>/dev/null || head -50 $searchdir/{}" \
        --preview-window=right:60% \
        --prompt="Search: " \
        --phony \
        --bind "change:reload:rg --files-with-matches --no-messages {q} $searchdir 2>/dev/null | sed 's|^$searchdir/||' || find $searchdir -type f -name '*.md' -not -path '*/.git/*' | sed 's|^$searchdir/||'" \
        --bind "ctrl-e:execute(nvim $searchdir/{})")

  # Enter = view with glow, ctrl-e = edit in nvim
  if [[ -n "$result" ]]; then
    glow -p "$searchdir/$result"
  fi
}
